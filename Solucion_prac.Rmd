---
title: "Deployment: Model-agnostic methods"
author: "Alba"
date: '2023-04-30'
output: html_document
---

## 1.- One dimensional Partial Dependence Plot.
The partial dependence plot shows the marginal effect of a feature on the predicted outcome of a previously fit model. 
 
#### EXERCISE:
Apply PDP to the regression example of predicting bike rentals. Fit a random forest approximation for the prediction of bike rentals (cnt). Use the partial dependence plot to visualize the relationships the model learned. Use the slides shown in class as model.  


```{r setup}
library(randomForestSRC)
library(ggplot2)
library(gridExtra)
library(dplyr)
library(plotly)
library(reshape2)
library(lubridate)
library(pdp)
library(randomForest)


days <- read.csv("/Users/albitadubonllamas/Desktop/Practica5EDM/day.csv", row.names = 1)
hour <- read.csv("/Users/albitadubonllamas/Desktop/Practica5EDM/hour.csv")
```


PreparaciÃ³n base de datos. Ajuste variables:

```{r}
#class(days$dteday)
days$dteday <- as_date(days$dteday)

data <- days %>% 
  mutate(spring = ifelse(season == 1, 1, 0),
         summer = ifelse(season == 2, 1, 0),
         fall = ifelse(season == 3, 1, 0))
data <- data %>% 
  mutate(MISTY = ifelse(weathersit == 2, 1, 0),
         RAIN = ifelse(weathersit %in% c(3,4), 1, 0))

data$temp <- days$temp * 39 + (-8)
data$hum <- days$hum * 100
data$windspeed <- days$windspeed * 67
start_date <- as.Date("2011-01-01")
data$days_since_2011 <- as.numeric(as.Date(days$dteday) - start_date)
data <- data[, c("holiday", "workingday", "summer", "MISTY", "RAIN", "temp", "fall", "hum", "windspeed", "days_since_2011", "cnt")]
```


Aplico random forest
```{r, warning=FALSE}
rf <- randomForest(cnt~., data=data)
rf
```

DAYS_SINCE

```{r, warning=FALSE}
pdp<- pdp::partial(rf, pred.var = 'days_since_2011', plot = F)
#pdp <- as.data.frame(pdp)
plot_ly(pdp, x = ~days_since_2011, y = ~yhat, type = "scatter", mode = "lines")
```


HUMIDITY

```{r, warning=FALSE}
pdp<- pdp::partial(rf, pred.var = 'hum', plot = F)
#pdp <- as.data.frame(pdp)
plot_ly(pdp, x = ~hum, y = ~yhat, type = "scatter", mode = "lines")
```

TEMPERATURE

```{r, warning=FALSE}
pdp<- pdp::partial(rf, pred.var = 'temp', plot = F)
#pdp <- as.data.frame(pdp)
plot_ly(pdp, x = ~temp, y = ~yhat, type = "scatter", mode = "lines")
```

WIND SPEED

```{r, warning=FALSE}
pdp<- pdp::partial(rf, pred.var = 'windspeed', plot = F)
#pdp <- as.data.frame(pdp)
plot_ly(pdp, x = ~windspeed, y = ~yhat, type = "scatter", mode = "lines")
```

#### QUESTION:
Analyse the influence of days since 2011, temperature, humidity and wind speed on the predicted bike counts.


-------------------------------------------------------------------------------

## 2.- Bidimensional Partial Dependency Plot.

#### EXERCISE:
Generate a 2D Partial Dependency Plot with humidity and temperature to predict the number of bikes rented depending on those parameters.

##### BE CAREFUL: due to the size, extract a set of random samples from the BBDD before generating the data for the Partial Dependency Plot. 

Show the density distribution of both input features with the 2D plot as shown in the class slides. 

##### TIP: Use geom_tile() to generate the 2D plot. Set width and height to avoid holes. 


```{r message=FALSE}

sample <- data %>% sample_n(size = 400, replace = FALSE)
rf_sample <- randomForest(cnt ~., data = sample)


pdp::partial(rf_sample, pred.var = c("temp", "hum"), train = sample, grid.resolution = 20, plot=T)
```

```{r}

# Density distributions for input features

temp_plot <- ggplot(sample, aes(x = temp)) + 
  geom_density(fill = "blue", alpha = 0.5) +
  labs(x = "Temperature", y = "Density") +
  theme_bw()

hum_plot <- ggplot(sample, aes(x = hum)) + 
  geom_density(fill = "blue", alpha = 0.5) +
  labs(x = "Humidity", y = "Density") +
  theme_bw()



plot_grid(temp_plot, hum_plot, ncol = 1, nrow = 2)

```


#### QUESTION:
Interpret the results:


-------------------------------------------------------------------------------


## 3.- PDP to explain the price of a house.

#### EXERCISE:
Apply the previous concepts to predict the price of a house from the database kc_house_data.csv. In this case, use again a random forest approximation for the prediction based on the features bedrooms, bathrooms, sqft_living, sqft_lot, floors and yr_built. Use the partial dependence plot to visualize the relationships the model learned.

##### BE CAREFUL: due to the size, extract a set of random samples from the BBDD before generating the data for the Partial Dependency Plot. 

```{r}
house <- read.csv("/Users/albitadubonllamas/Desktop/Practica5EDM/kc_house_data.csv")
house_sample <- house %>% sample_n(size = 10000, replace = FALSE)
```


```{r}
house_data_rf <- house_sample[, c('price',"bedrooms", "bathrooms", "sqft_living", "sqft_lot", "floors", "yr_built")]

rf_house <- randomForest(price~., data=house_data_rf)
```


```{r}
pdp_bed <- pdp::partial(rf_house, pred.var = "bedrooms", plot = TRUE, plot.engine = "ggplot2") + ylab("Price")
pdp_bath <- pdp::partial(rf_house, pred.var = "bathrooms", plot = TRUE, plot.engine = "ggplot2") + ylab("Price") + scale_y_continuous(labels = scales::number_format(scale = 1, big.mark = ""))
pdp_sqft <- pdp::partial(rf_house, pred.var = "sqft_living", plot = TRUE,plot.engine = "ggplot2") + ylab("Price")
pdp_floors <- pdp::partial(rf_house, pred.var = "floors", plot = TRUE, plot.engine = "ggplot2") + ylab("Price")
pdp_yr_built <- pdp::partial(rf_house, pred.var = "yr_built", plot = TRUE, plot.engine = "ggplot2") + ylab("Price")
pdp_sqft_lot <- pdp::partial(rf_house, pred.var = "sqft_lot", plot = TRUE, plot.engine = "ggplot2") + ylab("Price")
```

```{r}
library(ggplot2)

p1 <- ggplot(pdp_bed$data, aes(x = bedrooms, y = yhat)) + 
      geom_line(color = "blue") +
      labs(title = "PDP for Bedrooms", x = "Bedrooms", y = "Predicted Value")

p2 <- ggplot(pdp_bath$data, aes(x = bathrooms, y = yhat)) + 
      geom_line(color = "blue") +
      labs(title = "PDP for Bathrooms", x = "Temperature", y = "Predicted Value")

p3 <- ggplot(pdp_sqft$data, aes(x = sqft_living, y = yhat)) + 
      geom_line(color = "blue") +
      labs(title = "PDP for Square Footage", x = "Sqft_living", y = "Predicted Value")

p4 <- ggplot(pdp_floors$data, aes(x = floors, y = yhat)) + 
      geom_line(color = "blue") +
      labs(title = "PDP for Number of Floors", x = "Floors", y = "Predicted Value")

p5 <- ggplot(pdp_yr_built$data, aes(x = yr_built, y = yhat)) + 
      geom_line(color = "blue") +
      labs(title = "PDP for Year Built", x = "Year Built", y = "Predicted Value")

p6 <- ggplot(pdp_sqft_lot$data, aes(x = sqft_lot, y = yhat)) + 
      geom_line(color = "blue") +
      labs(title = "PDP for sqft_lot", x = "sqft_lot", y = "Predicted Value")

plot_grid(p1, p2, p3, p4,p5,p6, ncol = 3, nrow = 2)

```




#### QUESTION:
Analyse the influence of bedrooms, bathrooms, sqft_living and floors on the predicted price.



